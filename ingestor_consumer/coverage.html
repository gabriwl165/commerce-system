
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>kafka: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/gabriwl165/commerce-system/cmd/kafka/main.go (0.0%)</option>
				
				<option value="file1">github.com/gabriwl165/commerce-system/infra/env/main.go (0.0%)</option>
				
				<option value="file2">github.com/gabriwl165/commerce-system/internal/domain/services/process_consumption/process_consumption.go (100.0%)</option>
				
				<option value="file3">github.com/gabriwl165/commerce-system/internal/infra/broker/kafka/consumer.go (0.0%)</option>
				
				<option value="file4">github.com/gabriwl165/commerce-system/internal/infra/broker/kafka/producer.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package main

import (
        "context"
        "fmt"
        "log"
        "os"
        "os/signal"
        "syscall"
        "time"

        "github.com/gabriwl165/commerce-system/infra/env"
        "github.com/gabriwl165/commerce-system/internal/domain/services/process_consumption"
        "github.com/gabriwl165/commerce-system/internal/domain/services/pulses_consumer"
        "github.com/gabriwl165/commerce-system/internal/infra/broker/kafka"
        "github.com/gabriwl165/commerce-system/internal/pkg"
)

func main() <span class="cov0" title="0">{
        envManager := env.Init()
        kafkaBroker, _ := envManager.Read("KAFKA_BROKER")
        brokers := []string{
                kafkaBroker.(string),
        }
        topic_producer := "processor-storage-consumption"
        producer := kafka.InitProducer(brokers, topic_producer)
        StartScheduleConsumer(producer, envManager)
}</span>

func StartScheduleConsumer(producer pkg.BrokerProducer, envManager *env.EnvManager) <span class="cov0" title="0">{
        ctx, stop := signal.NotifyContext(context.Background(), os.Interrupt, syscall.SIGTERM)
        defer stop()
        for </span><span class="cov0" title="0">{

                consumptionChan := make(chan map[string]interface{})
                go process_consumption.ProcessConsumption(producer, consumptionChan)

                select </span>{
                case &lt;-ctx.Done():<span class="cov0" title="0">
                        fmt.Println("Shutdown signal received, exiting...")
                        return</span>

                default:<span class="cov0" title="0">

                        kafkaBroker, _ := envManager.Read("KAFKA_BROKER")
                        brokers := []string{kafkaBroker.(string)}
                        topic_consumer := "resource-consumption"

                        consumer := &amp;kafka.KafkaBrokerConsumer{}
                        consumer.Init(brokers, topic_consumer, "ingestor-consumer")

                        log.Print("Running Consumer.")
                        pulses_consumer.StartConsumer(consumer, consumptionChan, time.Duration(60))
                        close(consumptionChan)
                        time.Sleep(10 * time.Second)</span>

                }
        }
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package env

import (
        "errors"
        "log"
        "os"
        "strings"
)

type EnvManager struct {
        envs map[string]any
}

func (e *EnvManager) Read(key string) (any, error) <span class="cov0" title="0">{
        value, ok := e.envs[key]
        if !ok </span><span class="cov0" title="0">{
                return nil, errors.New("Key Not Found")
        }</span>
        <span class="cov0" title="0">return value, nil</span>
}

func (e *EnvManager) Write(key string, value string) <span class="cov0" title="0">{
        e.envs[key] = value
}</span>

func Init() *EnvManager <span class="cov0" title="0">{
        envManager := &amp;EnvManager{
                envs: make(map[string]any),
        }
        for _, env := range os.Environ() </span><span class="cov0" title="0">{
                values := strings.Split(env, "=")
                envManager.Write(values[0], values[1])
        }</span>
        <span class="cov0" title="0">log.Print(envManager.envs)
        return envManager</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package process_consumption

import (
        "context"
        "fmt"
        "strings"
        "sync"

        "github.com/gabriwl165/commerce-system/internal/pkg"
)

type Aggregator struct {
        mu   sync.Mutex
        data map[string]float64
}

func NewAggregator() *Aggregator <span class="cov8" title="1">{
        return &amp;Aggregator{
                data: make(map[string]float64),
        }
}</span>

func (a *Aggregator) Add(tenant, productSKU, useUnity string, usedAmount float64) <span class="cov8" title="1">{
        key := fmt.Sprintf("%s:%s:%s", tenant, productSKU, useUnity)
        a.mu.Lock()
        defer a.mu.Unlock()
        a.data[key] += usedAmount
}</span>

func (a *Aggregator) GetData() []map[string]interface{} <span class="cov8" title="1">{
        a.mu.Lock()
        defer a.mu.Unlock()
        result := make([]map[string]interface{}, 0)
        for key, value := range a.data </span><span class="cov8" title="1">{
                parts := strings.Split(key, ":")
                tenant, product, use_unity := parts[0], parts[1], parts[2]
                result = append(result, map[string]interface{}{
                        "tenant":      tenant,
                        "product":     product,
                        "use_unity":   use_unity,
                        "used_amount": value,
                })

        }</span>
        <span class="cov8" title="1">return result</span>
}

func ProcessConsumption(producer pkg.BrokerProducer, consumptionChan &lt;-chan map[string]interface{}) <span class="cov8" title="1">{
        agg := NewAggregator()
        for consumption := range consumptionChan </span><span class="cov8" title="1">{
                tenant := consumption["tenant"].(string)
                productSKU := consumption["product_sku"].(string)
                useUnity := consumption["use_unity"].(string)
                usedAmount := consumption["used_amount"].(float64)

                agg.Add(tenant, productSKU, useUnity, usedAmount)
        }</span>
        <span class="cov8" title="1">pulses := agg.GetData()
        for _, pulse := range pulses </span><span class="cov8" title="1">{
                tenant := pulse["tenant"].(string)
                producer.Write(context.Background(), tenant, pulse)
        }</span>

}
</pre>
		
		<pre class="file" id="file3" style="display: none">package kafka

import (
        "context"
        "errors"

        "github.com/gabriwl165/commerce-system/internal/pkg"
        "github.com/segmentio/kafka-go"
)

type KafkaBrokerConsumer struct {
        reader *kafka.Reader
}

func (k *KafkaBrokerConsumer) Init(brokers []string, topic string, groupID string) <span class="cov0" title="0">{
        k.reader = kafka.NewReader(kafka.ReaderConfig{
                Brokers: brokers,
                GroupID: groupID,
                Topic:   topic,
        })
}</span>

func (k *KafkaBrokerConsumer) Read(ctx context.Context) (pkg.MessageContent, error) <span class="cov0" title="0">{
        msg, err := k.reader.ReadMessage(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">return &amp;KafkaMessageContent{Message: msg}, nil</span>
}

type KafkaMessageContent struct {
        Message kafka.Message
}

func (m *KafkaMessageContent) AsString() (string, error) <span class="cov0" title="0">{
        if m.Message.Value == nil </span><span class="cov0" title="0">{
                return "", errors.New("message value is nil")
        }</span>
        <span class="cov0" title="0">return string(m.Message.Value), nil</span>
}

func (m *KafkaMessageContent) AsBytes() ([]byte, error) <span class="cov0" title="0">{
        if m.Message.Value == nil </span><span class="cov0" title="0">{
                return nil, errors.New("message value is nil")
        }</span>
        <span class="cov0" title="0">return m.Message.Value, nil</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package kafka

import (
        "context"
        "encoding/json"
        "errors"

        "github.com/segmentio/kafka-go"
)

type KafkaProducer struct {
        writer *kafka.Writer
}

var ErrProducerNotInitialized = errors.New("kafka producer not initialized")

func NewProducer(brokers []string, topic string) *KafkaProducer <span class="cov0" title="0">{
        return &amp;KafkaProducer{
                writer: &amp;kafka.Writer{
                        Addr:     kafka.TCP(brokers...),
                        Topic:    topic,
                        Balancer: &amp;kafka.LeastBytes{},
                },
        }
}</span>

func (p *KafkaProducer) Write(ctx context.Context, key any, value any) error <span class="cov0" title="0">{
        bytes, err := json.Marshal(value)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">stringKey, ok := key.(string)
        if !ok </span><span class="cov0" title="0">{
                return errors.New("String must be a string")
        }</span>

        <span class="cov0" title="0">msg := kafka.Message{
                Key:   []byte(stringKey),
                Value: []byte(string(bytes)),
        }

        err = p.writer.WriteMessages(ctx, msg)
        return err</span>
}

func (p *KafkaProducer) Close() error <span class="cov0" title="0">{
        return p.writer.Close()
}</span>

func InitProducer(brokers []string, topic string) *KafkaProducer <span class="cov0" title="0">{
        producer := NewProducer(brokers, topic)
        return producer
}</span>
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
